# Figure Guide

This document describes the figures generated by the `spinalmodes` package and their interpretation.

## Overview

All figures follow strict validation requirements:
- **Format:** PNG (no alpha channel)
- **Resolution:** 300 DPI minimum
- **Width:** 1800–3600 pixels
- **Metadata:** JSON sidecar with parameters and code version
- **Data:** CSV with source data (≥50 rows for maps)

## Figure 1: IEC Discriminators

**File:** `outputs/figs/fig_iec_discriminators.png`

**Description:** Three-panel figure showing key discriminating features of IEC couplings.

### Panel A: Node Drift (IEC-1)

**What it shows:** Mean node position shift vs. target curvature coupling χ_κ

**Interpretation:**
- X-axis: χ_κ (coupling strength, units: m)
- Y-axis: Mean node drift (mm)
- Linear relationship demonstrates that information gradients shift pattern phase
- Wavelength remains constant (discriminates from wavelength-changing mechanisms)

**Expected behavior:**
- Slope ~70 mm per unit χ_κ (for step function I(s))
- Intercept near 0 for χ_κ = 0 (baseline)

### Panel B: Amplitude Modulation (IEC-2)

**What it shows:** Deformation amplitude vs. constitutive coupling χ_E

**Interpretation:**
- X-axis: χ_E (dimensionless)
- Y-axis: Amplitude (degrees)
- Negative χ_E (softer tissue) increases amplitude
- Positive χ_E (stiffer tissue) decreases amplitude
- Demonstrates mechanical amplification/suppression at fixed load

**Expected behavior:**
- ~30% amplitude change for χ_E = ±0.25
- Monotonic decrease with increasing χ_E

### Panel C: Helical Threshold Map (IEC-3)

**What it shows:** Helical instability threshold in (ΔB, ||∇I||) parameter space

**Interpretation:**
- X-axis: Asymmetry ΔB (dimensionless)
- Y-axis: Information gradient ||∇I|| (1/m)
- Color: Threshold value (lower = easier to reach helical mode)
- Black contour: Critical threshold (0.05)
- Region below contour: Helical instability likely

**Expected behavior:**
- Threshold decreases with increasing ||∇I|| (active forces)
- Threshold increases with ΔB (asymmetry)
- Critical contour follows approximately ||∇I|| ∝ √(ΔB)

**Generation:**
```bash
poetry run python -c "from spinalmodes.fig_iec_discriminators import generate_fig_iec_discriminators; generate_fig_iec_discriminators()"
```

**Data files:**
- `outputs/csv/fig_iec_discriminators.csv`: Source data for all panels
- `outputs/figs/fig_iec_discriminators.json`: Metadata

---

## Figure 2: Phase Diagram

**File:** `outputs/figs/fig_iec_phase.png`

**Description:** Phase diagram showing planar-to-helical transition boundary.

**Interpretation:**
- Contour plot of threshold values
- Red contour marks critical boundary
- Regions can be labeled as "planar" or "helical" based on threshold

**Generation:**
```bash
poetry run spinalmodes iec phase \
  --delta-b 0.0:0.2:41 \
  --gradI 0.0:0.1:21 \
  --out-csv outputs/csv/iec_phase_map.csv \
  --out-fig outputs/figs/fig_iec_phase.png
```

**Use cases:**
- Predict scoliosis risk based on (ΔB, ||∇I||) measurements
- Design experiments to test boundary location
- Validate model against clinical/experimental data

---

## Figure 3: Node Drift Demonstration

**File:** `outputs/figs/fig_iec_node_drift.png`

**Description:** Two-panel comparison of baseline vs. IEC-1 coupling.

### Panel 1: Angle Profiles
- Blue solid line: Baseline (χ_κ = 0)
- Red dashed line: IEC-1 (χ_κ = 0.04)
- Vertical dotted lines: Node positions

### Panel 2: Node Position Comparison
- Blue circles: Baseline node positions
- Red triangles: IEC-1 node positions
- Horizontal offset shows drift

**Generation:**
```bash
poetry run spinalmodes iec node-drift \
  --I-mode step \
  --chi-kappa 0.04 \
  --out-fig outputs/figs/fig_iec_node_drift.png
```

**Interpretation:**
- Drift > 0 confirms IEC-1 effect
- Wavelength constancy confirms mechanism specificity

---

## Figure 4: Helical Threshold

**File:** `outputs/figs/fig_iec_threshold.png`

**Description:** Helical threshold vs. active coupling χ_f at fixed information gradient.

**Interpretation:**
- X-axis: χ_f (active coupling strength)
- Y-axis: Threshold value
- Red dashed line: Critical threshold (0.05)
- Decreasing curve shows threshold reduction with active forces

**Generation:**
```bash
poetry run spinalmodes iec helical-threshold \
  --gradI 0.05 \
  --out-fig outputs/figs/fig_iec_threshold.png
```

**Use cases:**
- Quantify effect of ciliary forces on scoliosis risk
- Design therapeutic interventions targeting χ_f

---

## Custom Figures

### Creating Custom Analyses

You can create custom figures by importing the IEC module:

```python
from spinalmodes.iec import IECParameters, apply_iec_coupling, solve_beam_static
import matplotlib.pyplot as plt
import numpy as np

# Set up parameters
params = IECParameters(
    chi_kappa=0.03,
    chi_E=-0.2,
    I_mode="gaussian",
    I_center=0.5,
    n_nodes=200
)

# Generate fields
s = params.get_s_array()
kappa_t, E_f, C_f, M_a = apply_iec_coupling(s, params)

# Solve
theta, kappa = solve_beam_static(s, kappa_t, E_f, M_a)

# Plot
fig, ax = plt.subplots(figsize=(8, 6), dpi=300)
ax.plot(s * 1000, np.rad2deg(theta))
ax.set_xlabel("Position (mm)")
ax.set_ylabel("Angle (deg)")
plt.tight_layout()
plt.savefig("outputs/figs/custom_analysis.png", dpi=300)
```

### Validation

Always validate custom figures:

```bash
poetry run python tools/validate_figures.py
```

Fix any errors reported (DPI, width, alpha channel, sidecar JSON).

---

## Figure Specifications

### Required Metadata (JSON Sidecar)

Each figure must have a corresponding `.json` file with:

```json
{
  "figure_type": "descriptive_name",
  "parameters": {
    "chi_kappa": 0.04,
    "I_mode": "step",
    "length_m": 0.4,
    "n_nodes": 100
  },
  "results": {
    "wavelength_mm": 123.4,
    "amplitude_deg": 12.3,
    "node_positions_mm": [45.2, 123.8, 202.3]
  },
  "data_source": "outputs/csv/associated_data.csv",
  "figure_specs": {
    "width_px": 2400,
    "height_px": 1800,
    "dpi": 300,
    "format": "PNG"
  },
  "code_version": "0.1.0",
  "seed": null
}
```

### Color Schemes

Recommended color palettes for consistency:

- **IEC-1 (Node drift):** `#2E86AB` (blue)
- **IEC-2 (Amplitude):** `#A23B72` (magenta)
- **IEC-3 (Threshold):** `#F18F01` (orange)
- **Baseline:** Gray (`#888888`)

### Fonts

- **Title:** 13–14 pt, bold
- **Axis labels:** 10–12 pt
- **Legend:** 9–10 pt
- **Annotations:** 8–9 pt

### Export Settings

```python
plt.savefig(
    "output.png",
    dpi=300,
    bbox_inches="tight",
    transparent=False,  # No alpha!
    format="png"
)
```

---

## Troubleshooting

### Figure Validation Fails

**Problem:** DPI < 300  
**Solution:** Specify `dpi=300` in `plt.subplots()` and `plt.savefig()`

**Problem:** Width outside 1800–3600 px  
**Solution:** Adjust `figsize` parameter: `figsize=(width_inches, height_inches)` where `width_px = width_inches * dpi`

**Problem:** Alpha channel detected  
**Solution:** Set `transparent=False` in `savefig()` and ensure image mode is RGB, not RGBA

**Problem:** Missing sidecar JSON  
**Solution:** Generate JSON metadata after creating figure (see examples above)

### Large File Sizes

If PNG files are too large (>10 MB):
- Reduce figure complexity (fewer plot elements)
- Use `optimize=True` in Pillow if post-processing
- Consider vector format (SVG) for supplementary materials

---

## See Also

- [CLI Reference](cli.md)
- [Manuscript](manuscript/SpinalCountercurvature_IEC.md)
- [Validation Tool](../tools/validate_figures.py)

